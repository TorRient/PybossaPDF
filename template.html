<style type="text/css">
    #the-canvas {
        cursor: move;
    }

    body {
        background-color: #eee;
        font-family: sans-serif;
        margin: 0;
    }

    .pdfViewer .canvasWrapper {
        box-shadow: 0 0 3px #bbb;
    }

    .pdfViewer .page {
        margin-bottom: 10px;
    }

    .annotationLayer {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
    }

    .toolbar {
        margin-top: 60px;
    }

    #content-wrapper {
        position: absolute;
        top: 35px;
        left: 0;
        right: 200px;
        bottom: 0;
        overflow: auto;
    }

    #comment-wrapper {
        position: absolute;
        top: 35px;
        right: 0;
        bottom: 0;
        overflow: auto;
        width: 200px;
        background: #eaeaea;
        border-left: 1px solid #d0d0d0;
    }

    #comment-wrapper h4 {
        margin: 10px;
    }

    #comment-wrapper .comment-list {
        font-size: 12px;
        position: absolute;
        top: 38px;
        left: 0;
        right: 0;
        bottom: 0;
    }

    #comment-wrapper .comment-list-item {
        border-bottom: 1px solid #d0d0d0;
        padding: 10px;
    }

    #comment-wrapper .comment-list-container {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 47px;
        overflow: auto;
    }

    #comment-wrapper .comment-list-form {
        position: absolute;
        left: 0;
        right: 0;
        bottom: 0;
        padding: 10px;
    }

    #comment-wrapper .comment-list-form input {
        padding: 5px;
        width: 100%;
    }

    .pdfViewer .page {
        border-image: none;
    }
</style>
<link rel="stylesheet" type="text/css" href="/static/annotate/shared/toolbar.css" />
<link rel="stylesheet" type="text/css" href="/static/annotate/shared/pdf_viewer.css" />
<div class="row">
    <!-- Success and Error Messages for the user -->
    <div class="col-md-6 col-md-offset-2" style="height:50px">
        <div id="success" class="alert alert-success" style="display:none;">
            <a class="close">Ã—</a>
            <strong>Well done! Your answer has been saved</strong>
        </div>
        <div id="taskcompleted" class="alert alert-info" style="display:none;">
            <strong>The task has been completed! Thanks a lot!</strong>
        </div>
        <div id="loading" class="alert alert-info">
            <strong>Loading the PDF file...</strong>
        </div>
        <div id="finish" class="alert alert-success" style="display:none;">
            <strong>Congratulations! You have participated in all available tasks!</strong>
            <br />
            <div class="alert-actions">
                <a class="btn small" href="/">Go back</a>
                <a class="btn small" href="/project">or, Check other projects</a>
            </div>
        </div>
        <div id="error" class="alert alert-danger" style="display:none;">
            <a class="close">Ã—</a>
            <strong>Error! Something went wrong, please contact the site administrators</strong>
        </div>
    </div>
</div> <!-- End Success and Error Messages for the user -->
<div class="row skeleton">
    <div id="question" class="col-md-12">
        <h1>Question</h1>
        <span class="label label-info"><i class="fa fa-bullhorn"></i> Important</span> <strong>This is just a
            demo
            project. You can re-use the code to create your own project.</strong>
        <hr>
    </div>
</div>
<div class="row skeleton">
    <!-- Answer buttons -->
    <div id="answer" class="col-sm-9" style="text-align:center;">
        <div class="btn-group-md" style="padding-bottom:5px;">
            <button id="prev" class="btn btn-primary btn-navigate disabled" value="prev"><i
                    class="fa fa-arrow-left"></i></button>
            <button class="btn btn-primary btn-zoom" value=0>1:1</button>
            <button class="btn btn-primary btn-zoom" value=1><i class="fa fa-search-plus"></i></button>
            <button class="btn btn-primary btn-zoom" value=-1><i class="fa fa-search-minus"></i></button>
            <button id="next" class="btn btn-primary btn-navigate" value="next"><i
                    class="fa fa-arrow-right"></i></button>
        </div>
        <div class="toolbar">
            <button class="cursor" type="button" title="Cursor" data-tooltype="cursor">âžš</button>

            <div class="spacer"></div>

            <button class="rectangle" type="button" title="Rectangle" data-tooltype="area">&nbsp;</button>
            <button class="highlight" type="button" title="Highlight" data-tooltype="highlight">&nbsp;</button>
            <button class="strikeout" type="button" title="Strikeout" data-tooltype="strikeout">&nbsp;</button>

            <div class="spacer"></div>

            <button class="text" type="button" title="Text Tool" data-tooltype="text"></button>
            <select class="text-size"></select>
            <div class="text-color"></div>

            <div class="spacer"></div>

            <button class="pen" type="button" title="Pen Tool" data-tooltype="draw">âœŽ</button>
            <select class="pen-size"></select>
            <div class="pen-color"></div>

            <div class="spacer"></div>

            <button class="comment" type="button" title="Comment" data-tooltype="point">ðŸ—¨</button>

            <div class="spacer"></div>

            <select class="scale">
                <option value=".5">50%</option>
                <option value="1">100%</option>
                <option value="1.33">133%</option>
                <option value="1.5">150%</option>
                <option value="2">200%</option>
            </select>

            <a href="javascript://" class="rotate-ccw" title="Rotate Counter Clockwise">âŸ²</a>
            <a href="javascript://" class="rotate-cw" title="Rotate Clockwise">âŸ³</a>

            <div class="spacer"></div>

            <a href="javascript://" class="clear" title="Clear">Ã—</a>
        </div>
        <div id="content-wrapper">
            <div id="viewer" class="pdfViewer"></div>
        </div>
        <div id="comment-wrapper">
            <h4>Comments</h4>
            <div class="comment-list">
                <div class="comment-list-container">
                    <div class="comment-list-item">No comments</div>
                </div>
                <form class="comment-list-form" style="display:none;">
                    <input type="text" placeholder="Add a Comment" />
                </form>
            </div>
        </div>
        <div id="pages" style="margin-top:2%;">
            <p>Page <span id="currentPage">#</span> of <span id="totalPages">#</span></p>
        </div>
    </div>
    <div class="col-sm-12">
        <p>You are working now on task: <span id="task-id" class="label label-warning">#</span></p>
        <p>You have completed: <span id="done" class="label label-info"></span> tasks from
            <span id="total" class="label label-info"></span></p>
        <div class="progress progress-striped">
            <div id="progress" rel="tooltip" title="#" class="progress-bar" style="width: 0%;" role="progressbar">
            </div>
        </div>
        <div>
            <h5>Write here the transcription</h5>
            <form class="form-inline">
                <textarea id="text" rows="10" style="width:100%;"></textarea>
            </form>
            <button class="btn btn-submit">Submit transcription!</button>
        </div>
    </div>
</div>

<script src="http://code.jquery.com/ui/1.9.1/jquery-ui.js"></script>
<script src="http://hitconsultants.com/dragscroll_scrollsync/scrollsync.js"></script>
<script src="http://hitconsultants.com/dragscroll_scrollsync/dragscrollable.js"></script>
<script src="/static/js/pybossa/pybossa.js" type="text/javascript"></script>

<script src="/static/annotate/shared/pdf.js"></script>
<script src="/static/annotate/shared/pdf_viewer.js"></script>
<script src="/static/annotate/dist/pdf-annotate.js"></script>
<script src="/static/annotate/shared/initColorPicker.js"></script>
<!-- <script src="/static/annotate/twitter-text.js"></script> -->
<script src="/static/annotate/twitter.min.js"></script>
<script type="module">

    // const { UI } = PDFAnnotate;
    // const documentId = 'https://www.cbs.dk/files/cbs.dk/cv_template_sheet_en.pdf';
    // let PAGE_HEIGHT;
    // let RENDER_OPTIONS = {
    //     documentId,
    //     pdfDocument: null,
    //     scale: parseFloat(localStorage.getItem(`${documentId}/scale`), 10) || 1.33,
    //     rotate: parseInt(localStorage.getItem(`${documentId}/rotate`), 10) || 0
    // };

    // PDFAnnotate.setStoreAdapter(new PDFAnnotate.LocalStoreAdapter());
    // PDFJS.workerSrc = '/static/annotate/shared/pdf.worker.js';

    // // Render stuff
    // let NUM_PAGES = 0;
    // document.getElementById('content-wrapper').addEventListener('scroll', function (e) {
    //     let visiblePageNum = Math.round(e.target.scrollTop / PAGE_HEIGHT) + 1;
    //     let visiblePage = document.querySelector(`.page[data-page-number="${visiblePageNum}"][data-loaded="false"]`);
    //     if (visiblePage) {
    //         setTimeout(function () {
    //             UI.renderPage(visiblePageNum, RENDER_OPTIONS);
    //         });
    //     }
    // });

    // function render() {
    //     PDFJS.getDocument(RENDER_OPTIONS.documentId).then((pdf) => {
    //         RENDER_OPTIONS.pdfDocument = pdf;

    //         let viewer = document.getElementById('viewer');
    //         viewer.innerHTML = '';
    //         NUM_PAGES = pdf.pdfInfo.numPages;
    //         for (let i = 0; i < NUM_PAGES; i++) {
    //             let page = UI.createPage(i + 1);
    //             viewer.appendChild(page);
    //         }

    //         UI.renderPage(1, RENDER_OPTIONS).then(([pdfPage, annotations]) => {
    //             let viewport = pdfPage.getViewport(RENDER_OPTIONS.scale, RENDER_OPTIONS.rotate);
    //             PAGE_HEIGHT = viewport.height;
    //         });
    //     });
    // }
    // render();

</script>
<!-- Use latest PDF.js build from Github (it may not work in some browsers due to strict MIME type checking could be enabled) -->
<!-- <script type="text/javascript" src="https://raw.github.com/mozilla/pdf.js/gh-pages/build/pdf.js"></script>-->
<!-- For this reason we use the one provided by CrowdCrafting -->
<!-- <script src="/static/js/pdf/pdf.js" type="text/javascript"></script> -->


<script type="text/javascript">
    (function () {
        //
        // Disable workers to avoid yet another cross-origin issue (workers need the URL of
        // the script to be loaded, and currently do not allow cross-origin scripts)
        //
        // PDFJS.disableWorker = true;

        //
        // Get page info from document, resize canvas accordingly, and render page
        //

        function renderPage(task) {
            // Using promise to fetch the page
            task.pdfDoc.getPage(task.pageNum).then(function (page) {
                var viewport = page.getViewport(task.scale);
                task.canvas.height = viewport.height;
                task.canvas.width = viewport.width;

                // Render PDF page into canvas context
                var renderContext = {
                    canvasContext: task.ctx,
                    viewport: viewport
                };
                page.render(renderContext);
            });
        }

        function zoom(task, v) {
            task.pdfDoc.getPage(task.pageNum).then(function (page) {
                if (v === 1) {
                    task.scale = task.scale + 0.1;
                    if (task.scale >= 2) {
                        task.scale = 2;
                    }
                }
                if (v === -1) {
                    task.scale = task.scale - 0.1;
                    if (task.scale <= 0) {
                        task.scale = 0.1;
                    }
                }
                if (v === 0) {
                    task.scale = 0.8;
                }
                var viewport = page.getViewport(task.scale + 0.1);
                task.canvas.height = viewport.height;
                task.canvas.width = viewport.width;

                // Render PDF page into canvas context
                var renderContext = {
                    canvasContext: task.ctx,
                    viewport: viewport
                };
                page.render(renderContext);
            });

        }

        function enableDisabledNavButtons(task) {
            if (task.pageNum === 1) {
                $("#next").removeClass("disabled");
                $("#prev").addClass("disabled");
            }
            else if (task.pageNum === task.pdfDoc.numPages) {
                $("#prev").removeClass("disabled");
                $("#next").addClass("disabled");
            }
            else {
                $("#next").removeClass("disabled");
                $("#prev").removeClass("disabled");
            }
        }

        function goPreviousPage(task) {
            if (task.pageNum <= 1)
                return;
            task.pageNum--;
            renderPage(task);
            $("#currentPage").text(task.pageNum);
            enableDisabledNavButtons(task);
        }

        function goNextPage(task) {
            if (task.pageNum >= task.pdfDoc.numPages)
                return;
            task.pageNum++;
            renderPage(task);
            $("#currentPage").text(task.pageNum);
            enableDisabledNavButtons(task);
        }

        function loadUserProgress() {
            pybossa.userProgress('pdf').done(function (data) {
                var pct = Math.round((data.done * 100) / data.total);
                $("#progress").css("width", pct.toString() + "%");
                $("#progress").attr("title", pct.toString() + "% completed!");
                $("#progress").tooltip({ 'placement': 'left' });
                $("#total").text(data.total);
                $("#done").text(data.done);
            });
        }

        function showPaginationOptions(task) {
            if (task.pagination) {
                $("#currentPage").text(task.pageNum);
                $("#totalPages").text(task.pdfDoc.numPages);
                $(".btn-navigate").show();
                $("#pages").show();
            }
            else {
                $(".btn-navigate").hide();
                $("#pages").hide();
            }
        }

        pybossa.taskLoaded(function (task, deferred) {
            console.log(task);
            const { UI } = PDFAnnotate;
            const documentId = '';
            let PAGE_HEIGHT;
            let RENDER_OPTIONS = {
                documentId,
                pdfDocument: null,
                scale: parseFloat(localStorage.getItem(`${documentId}/scale`), 10) || 1.33,
                rotate: parseInt(localStorage.getItem(`${documentId}/rotate`), 10) || 0
            };

            PDFAnnotate.setStoreAdapter(new PDFAnnotate.LocalStoreAdapter());
            PDFJS.workerSrc = '/static/annotate/shared/pdf.worker.js';

            // Render stuff
            let NUM_PAGES = 0;
            document.getElementById('content-wrapper').addEventListener('scroll', function (e) {
                let visiblePageNum = Math.round(e.target.scrollTop / PAGE_HEIGHT) + 1;
                let visiblePage = document.querySelector(`.page[data-page-number="${visiblePageNum}"][data-loaded="false"]`);
                if (visiblePage) {
                    setTimeout(function () {
                        UI.renderPage(visiblePageNum, RENDER_OPTIONS);
                    });
                }
            });

            function render() {
                PDFJS.getDocument(RENDER_OPTIONS.documentId).then((pdf) => {
                    RENDER_OPTIONS.pdfDocument = pdf;

                    let viewer = document.getElementById('viewer');
                    viewer.innerHTML = '';
                    NUM_PAGES = pdf.pdfInfo.numPages;
                    for (let i = 0; i < NUM_PAGES; i++) {
                        let page = UI.createPage(i + 1);
                        viewer.appendChild(page);
                    }

                    UI.renderPage(1, RENDER_OPTIONS).then(([pdfPage, annotations]) => {
                        let viewport = pdfPage.getViewport(RENDER_OPTIONS.scale, RENDER_OPTIONS.rotate);
                        PAGE_HEIGHT = viewport.height;
                    });
                });
            }

            // Text stuff
            (function () {
                let textSize;
                let textColor;

                function initText() {
                    let size = document.querySelector('.toolbar .text-size');
                    [8, 9, 10, 11, 12, 14, 18, 24, 30, 36, 48, 60, 72, 96].forEach((s) => {
                        size.appendChild(new Option(s, s));
                    });

                    setText(
                        localStorage.getItem(`${RENDER_OPTIONS.documentId}/text/size`) || 10,
                        localStorage.getItem(`${RENDER_OPTIONS.documentId}/text/color`) || '#000000'
                    );

                    initColorPicker(document.querySelector('.text-color'), textColor, function (value) {
                        setText(textSize, value);
                    });
                }

                function setText(size, color) {
                    let modified = false;

                    if (textSize !== size) {
                        modified = true;
                        textSize = size;
                        localStorage.setItem(`${RENDER_OPTIONS.documentId}/text/size`, textSize);
                        document.querySelector('.toolbar .text-size').value = textSize;
                    }

                    if (textColor !== color) {
                        modified = true;
                        textColor = color;
                        localStorage.setItem(`${RENDER_OPTIONS.documentId}/text/color`, textColor);

                        let selected = document.querySelector('.toolbar .text-color.color-selected');
                        if (selected) {
                            selected.classList.remove('color-selected');
                            selected.removeAttribute('aria-selected');
                        }

                        selected = document.querySelector(`.toolbar .text-color[data-color="${color}"]`);
                        if (selected) {
                            selected.classList.add('color-selected');
                            selected.setAttribute('aria-selected', true);
                        }

                    }

                    if (modified) {
                        UI.setText(textSize, textColor);
                    }
                }

                function handleTextSizeChange(e) {
                    setText(e.target.value, textColor);
                }

                document.querySelector('.toolbar .text-size').addEventListener('change', handleTextSizeChange);

                initText();
            })();

            // Pen stuff
            (function () {
                let penSize;
                let penColor;

                function initPen() {
                    let size = document.querySelector('.toolbar .pen-size');
                    for (let i = 0; i < 20; i++) {
                        size.appendChild(new Option(i + 1, i + 1));
                    }

                    setPen(
                        localStorage.getItem(`${RENDER_OPTIONS.documentId}/pen/size`) || 1,
                        localStorage.getItem(`${RENDER_OPTIONS.documentId}/pen/color`) || '#000000'
                    );

                    initColorPicker(document.querySelector('.pen-color'), penColor, function (value) {
                        setPen(penSize, value);
                    });
                }

                function setPen(size, color) {
                    let modified = false;

                    if (penSize !== size) {
                        modified = true;
                        penSize = size;
                        localStorage.setItem(`${RENDER_OPTIONS.documentId}/pen/size`, penSize);
                        document.querySelector('.toolbar .pen-size').value = penSize;
                    }

                    if (penColor !== color) {
                        modified = true;
                        penColor = color;
                        localStorage.setItem(`${RENDER_OPTIONS.documentId}/pen/color`, penColor);

                        let selected = document.querySelector('.toolbar .pen-color.color-selected');
                        if (selected) {
                            selected.classList.remove('color-selected');
                            selected.removeAttribute('aria-selected');
                        }

                        selected = document.querySelector(`.toolbar .pen-color[data-color="${color}"]`);
                        if (selected) {
                            selected.classList.add('color-selected');
                            selected.setAttribute('aria-selected', true);
                        }
                    }

                    if (modified) {
                        UI.setPen(penSize, penColor);
                    }
                }

                function handlePenSizeChange(e) {
                    setPen(e.target.value, penColor);
                }

                document.querySelector('.toolbar .pen-size').addEventListener('change', handlePenSizeChange);

                initPen();
            })();

            // Toolbar buttons
            (function () {
                let tooltype = localStorage.getItem(`${RENDER_OPTIONS.documentId}/tooltype`) || 'cursor';
                if (tooltype) {
                    setActiveToolbarItem(tooltype, document.querySelector(`.toolbar button[data-tooltype=${tooltype}]`));
                }

                function setActiveToolbarItem(type, button) {
                    let active = document.querySelector('.toolbar button.active');
                    if (active) {
                        active.classList.remove('active');

                        switch (tooltype) {
                            case 'cursor':
                                UI.disableEdit();
                                break;
                            case 'draw':
                                UI.disablePen();
                                break;
                            case 'text':
                                UI.disableText();
                                break;
                            case 'point':
                                UI.disablePoint();
                                break;
                            case 'area':
                            case 'highlight':
                            case 'strikeout':
                                UI.disableRect();
                                break;
                        }
                    }

                    if (button) {
                        button.classList.add('active');
                    }
                    if (tooltype !== type) {
                        localStorage.setItem(`${RENDER_OPTIONS.documentId}/tooltype`, type);
                    }
                    tooltype = type;

                    switch (type) {
                        case 'cursor':
                            UI.enableEdit();
                            break;
                        case 'draw':
                            UI.enablePen();
                            break;
                        case 'text':
                            UI.enableText();
                            break;
                        case 'point':
                            UI.enablePoint();
                            break;
                        case 'area':
                        case 'highlight':
                        case 'strikeout':
                            UI.enableRect(type);
                            break;
                    }
                }

                function handleToolbarClick(e) {
                    if (e.target.nodeName === 'BUTTON') {
                        setActiveToolbarItem(e.target.getAttribute('data-tooltype'), e.target);
                    }
                }

                document.querySelector('.toolbar').addEventListener('click', handleToolbarClick);
            })();

            // Scale/rotate
            (function () {
                function setScaleRotate(scale, rotate) {
                    scale = parseFloat(scale, 10);
                    rotate = parseInt(rotate, 10);

                    if (RENDER_OPTIONS.scale !== scale || RENDER_OPTIONS.rotate !== rotate) {
                        RENDER_OPTIONS.scale = scale;
                        RENDER_OPTIONS.rotate = rotate;

                        localStorage.setItem(`${RENDER_OPTIONS.documentId}/scale`, RENDER_OPTIONS.scale);
                        localStorage.setItem(`${RENDER_OPTIONS.documentId}/rotate`, RENDER_OPTIONS.rotate % 360);

                        render();
                    }
                }

                function handleScaleChange(e) {
                    setScaleRotate(e.target.value, RENDER_OPTIONS.rotate);
                }

                function handleRotateCWClick() {
                    setScaleRotate(RENDER_OPTIONS.scale, RENDER_OPTIONS.rotate + 90);
                }

                function handleRotateCCWClick() {
                    setScaleRotate(RENDER_OPTIONS.scale, RENDER_OPTIONS.rotate - 90);
                }

                document.querySelector('.toolbar select.scale').value = RENDER_OPTIONS.scale;
                document.querySelector('.toolbar select.scale').addEventListener('change', handleScaleChange);
                document.querySelector('.toolbar .rotate-ccw').addEventListener('click', handleRotateCCWClick);
                document.querySelector('.toolbar .rotate-cw').addEventListener('click', handleRotateCWClick);
            })();

            // Clear toolbar button
            (function () {
                function handleClearClick(e) {
                    if (confirm('Are you sure you want to clear annotations?')) {
                        for (let i = 0; i < NUM_PAGES; i++) {
                            document.querySelector(`div#pageContainer${i + 1} svg.annotationLayer`).innerHTML = '';
                        }

                        localStorage.removeItem(`${RENDER_OPTIONS.documentId}/annotations`);
                    }
                }
                document.querySelector('a.clear').addEventListener('click', handleClearClick);
            })();

            // Comment stuff
            (function (window, document) {
                let commentList = document.querySelector('#comment-wrapper .comment-list-container');
                let commentForm = document.querySelector('#comment-wrapper .comment-list-form');
                let commentText = commentForm.querySelector('input[type="text"]');

                function supportsComments(target) {
                    let type = target.getAttribute('data-pdf-annotate-type');
                    return ['point', 'highlight', 'area'].indexOf(type) > -1;
                }

                function insertComment(comment) {
                    let child = document.createElement('div');
                    child.className = 'comment-list-item';
                    child.innerHTML = twitter.autoLink(twitter.htmlEscape(comment.content));

                    commentList.appendChild(child); 
                    log(commentList)
                }

                function handleAnnotationClick(target) {
                    if (supportsComments(target)) {
                        let documentId = target.parentNode.getAttribute('data-pdf-annotate-document');
                        let annotationId = target.getAttribute('data-pdf-annotate-id');

                        PDFAnnotate.getStoreAdapter().getComments(documentId, annotationId).then((comments) => {
                            commentList.innerHTML = '';
                            commentForm.style.display = '';
                            commentText.focus();

                            commentForm.onsubmit = function () {
                                PDFAnnotate.getStoreAdapter().addComment(documentId, annotationId, commentText.value.trim())
                                    .then(insertComment)
                                    .then(() => {
                                        commentText.value = '';
                                        commentText.focus();
                                    });
                                
                                return false;
                            };

                            comments.forEach(insertComment);
                        });
                    }
                }

                function handleAnnotationBlur(target) {
                    if (supportsComments(target)) {
                        commentList.innerHTML = '';
                        commentForm.style.display = 'none';
                        commentForm.onsubmit = null;

                        insertComment({ content: 'No comments' });
                    }
                }

                UI.addEventListener('annotation:click', handleAnnotationClick);
                UI.addEventListener('annotation:blur', handleAnnotationBlur);
            })(window, document);

            // render();
            if (!$.isEmptyObject(task)) {
                RENDER_OPTIONS.documentId = task.info.pdf_url;
                render();
                if (task.state == 'completed') {
                    $('#answer').hide();
                    $('#taskcompleted').show();
                }
                // NOTE: 
                // Modifying the URL below to another server will likely *NOT* work. Because of browser
                // security restrictions, we have to use a file server with special headers
                // (CORS) - most servers don't support cross-origin browser requests.
                // Asynchronously download PDF as an ArrayBuffer
                var canvas = $("<canvas/>", { "id": "canvas_" + task.id });
                canvas.css("border", "1px solid black");
                var viewport = $("<div/>", { "id": "viewport_" + task.id });
                viewport.css("width", "100%");
                viewport.css("height", "100%");
                viewport.css("overflow", "auto");
                viewport.css("display", "none");
                viewport.append(canvas);
                $("#answer").append(viewport);

                $('#viewport_' + task.id).dragscrollable({ dragSelector: '#canvas_' + task.id });
                task.canvas = document.getElementById('canvas_' + task.id);
                task.ctx = document.getElementById("canvas_" + task.id).getContext('2d');
                task.scale = 0.9;
                task.pagination = (task.info.page === undefined);
                task.pageNum = task.info.page || 1;

                PDFJS.getDocument(task.info.pdf_url).then(function getPdfHelloWorld(_pdfDoc) {
                    task.pdfDoc = _pdfDoc;
                    deferred.resolve(task);
                });
            }
            else {
                deferred.resolve(task);
            }

        });

        pybossa.presentTask(function (task, deferred) {
            if (!$.isEmptyObject(task)) {
                loadUserProgress();
                $("textarea#text").val('');
                $("#viewport_" + task.id).show();
                showPaginationOptions(task);
                renderPage(task);
                $("#question h1").text(task.info.question);
                $("#task-id").text(task.id);
                $("#loading").hide();
                enableDisabledNavButtons(task);
                $(".btn-zoom").off('click').on('click', function (evt) {
                    zoom(task, parseInt($(this).attr("value")));
                });
                $(".btn-navigate").off('click').on('click', function (evt) {
                    if ($(this).attr("value") === "next") {
                        goNextPage(task);
                        return;
                    }
                    if ($(this).attr("value") === "prev") {
                        goPreviousPage(task);
                        return;
                    }
                });
                $(".btn-submit").off('click').on('click', function () {
                    var answer = $("textarea#text").val();
                    $("#viewport_" + task.id).hide();
                    pybossa.saveTask(task.id, answer).done(function (data) {
                        deferred.resolve();
                        $("#success").fadeIn();
                        setTimeout(function () { $("#success").fadeOut() }, 2000);
                    })
                });
            }
            else {
                $(".skeleton").hide();
                $("#finish").fadeIn();
            }
        });

        pybossa.run('pdf');
    })();
</script>